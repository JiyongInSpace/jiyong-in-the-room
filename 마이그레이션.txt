ë‹¨ê³„ë³„ êµ¬í˜„ ê³„íš - ë¡œì»¬ ìš°ì„  ì•„í‚¤í…ì²˜ ì „í™˜

  ğŸ“‹ Phase 1: ì½ê¸° ìµœì í™” (1ì£¼ì°¨)

  ëª©í‘œ: ì•± ì‹œì‘ ë° í™”ë©´ ì „í™˜ ì†ë„ ëŒ€í­ ê°œì„ 

  1-1. ë¡œì»¬ ìºì‹œ ë ˆì´ì–´ êµ¬ì¶•

  // lib/services/cache_service.dart ìƒì„±
  class CacheService {
    // íšŒì›ë„ ë¡œì»¬ ìºì‹œ ì‚¬ìš©
    static Future<List<DiaryEntry>> getCachedDiaries() async {
      // 1. ë¡œì»¬ ìºì‹œ í™•ì¸
      // 2. ì—†ìœ¼ë©´ DBì—ì„œ ë¡œë“œ í›„ ìºì‹œ
      // 3. ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° ì²´í¬
    }
  }

  1-2. ë©”ì¸ í™”ë©´ ì¦‰ì‹œ ë¡œë”©

  - HomeScreen: ë¡œì»¬ ë°ì´í„° ìš°ì„  í‘œì‹œ
  - í†µê³„: ë¡œì»¬ì—ì„œ ê³„ì‚°
  - ë°±ê·¸ë¼ìš´ë“œ ë¦¬í”„ë ˆì‹œ

  1-3. í…Œë§ˆ/ì¹´í˜ ë°ì´í„° ìºì‹±

  - ì•± ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ ë¡œë“œ
  - ë¡œì»¬ì— ì €ì¥ í›„ ì¬ì‚¬ìš©
  - ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ (1ì¼ 1íšŒ)

  ì˜ˆìƒ íš¨ê³¼: ì•± ì‹œì‘ 2-3ì´ˆ â†’ 0.1ì´ˆ

  ---
  ğŸ“‹ Phase 2: ì“°ê¸° ìµœì í™” (2ì£¼ì°¨)

  ëª©í‘œ: ì¦‰ê°ì ì¸ UI ë°˜ì‘

  2-1. Optimistic UI íŒ¨í„´ ì ìš©

  // ì¼ì§€ ì‘ì„± ì‹œ
  Future<void> saveDiary(DiaryEntry entry) async {
    // 1. ë¡œì»¬ ì €ì¥ (ì¦‰ì‹œ)
    await LocalStorage.saveDiary(entry);
    setState(() => diaries.add(entry)); // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸

    // 2. DB ì €ì¥ (ë°±ê·¸ë¼ìš´ë“œ)
    try {
      await DatabaseService.saveDiary(entry);
      entry.syncStatus = 'synced';
    } catch (e) {
      entry.syncStatus = 'pending';
      SyncQueue.add(entry);
    }
  }

  2-2. ë™ê¸°í™” ìƒíƒœ í‘œì‹œ

  - ê° ì•„ì´í…œì— ì‘ì€ ë™ê¸°í™” ì•„ì´ì½˜
  - pending: ğŸ”„ (ì£¼í™©ìƒ‰)
  - synced: âœ“ (ì´ˆë¡ìƒ‰)
  - error: âš ï¸ (ë¹¨ê°„ìƒ‰)

  2-3. ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™” í

  class SyncQueue {
    // 5ì´ˆë§ˆë‹¤ pending í•­ëª© ì¬ì‹œë„
    // ì‹¤íŒ¨ ì‹œ exponential backoff
    // ìµœëŒ€ ì¬ì‹œë„ 5íšŒ
  }

  ---
  ğŸ“‹ Phase 3: ì¶©ëŒ í•´ê²° (3ì£¼ì°¨)

  ëª©í‘œ: ë‹¤ì¤‘ ê¸°ê¸° ì§€ì›

  3-1. íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ ë²„ì „ ê´€ë¦¬

  class DiaryEntry {
    DateTime localUpdatedAt;   // ë¡œì»¬ ìˆ˜ì • ì‹œê°„
    DateTime? serverUpdatedAt; // ì„œë²„ ìˆ˜ì • ì‹œê°„
    String deviceId;           // ê¸°ê¸° ì‹ë³„ì
  }

  3-2. 3-way merge êµ¬í˜„

  // ì¶©ëŒ ê°ì§€ ë° í•´ê²°
  if (local.updatedAt != server.updatedAt) {
    if (local.localUpdatedAt > server.serverUpdatedAt) {
      // ë¡œì»¬ì´ ìµœì‹  â†’ ì„œë²„ ë®ì–´ì“°ê¸°
    } else {
      // ì„œë²„ê°€ ìµœì‹  â†’ ì‚¬ìš©ìì—ê²Œ ì„ íƒ ìš”ì²­
      showConflictDialog(local, server);
    }
  }

  3-3. ì„ íƒì  ë™ê¸°í™”

  - ì„¤ì •ì—ì„œ ë™ê¸°í™” on/off
  - Wi-Fiì—ì„œë§Œ ë™ê¸°í™” ì˜µì…˜
  - ìˆ˜ë™ ë™ê¸°í™” ë²„íŠ¼

  ---
  ğŸ“‹ Phase 4: ê³ ê¸‰ ê¸°ëŠ¥ (4ì£¼ì°¨)

  ëª©í‘œ: ì™„ë²½í•œ ì˜¤í”„ë¼ì¸ ê²½í—˜

  4-1. ì°¨ë“± ë™ê¸°í™”

  // ë³€ê²½ëœ ë¶€ë¶„ë§Œ ë™ê¸°í™”
  class SyncDelta {
    String fieldName;
    dynamic oldValue;
    dynamic newValue;
    DateTime timestamp;
  }

  4-2. ì••ì¶• ë° ë°°ì¹˜ ì²˜ë¦¬

  - ì—¬ëŸ¬ ë³€ê²½ì‚¬í•­ í•œ ë²ˆì— ì „ì†¡
  - gzip ì••ì¶•ìœ¼ë¡œ íŠ¸ë˜í”½ ì ˆê°

  4-3. ë™ê¸°í™” ë¶„ì„ ëŒ€ì‹œë³´ë“œ

  - ë™ê¸°í™” í†µê³„ (ì„±ê³µ/ì‹¤íŒ¨)
  - ë°ì´í„° ì‚¬ìš©ëŸ‰
  - ì¶©ëŒ íˆìŠ¤í† ë¦¬

  ---
  ğŸ“‹ Phase 5: ë§ˆì´ê·¸ë ˆì´ì…˜ (5ì£¼ì°¨)

  ëª©í‘œ: ê¸°ì¡´ ì‚¬ìš©ì ë¬´ì¤‘ë‹¨ ì „í™˜

  5-1. ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜

  // ì•± ì—…ë°ì´íŠ¸ ì‹œ
  if (isFirstLaunchAfterUpdate) {
    showMigrationDialog();
    // "ë” ë¹ ë¥¸ ì•±ì„ ìœ„í•´ ë°ì´í„°ë¥¼ ìµœì í™”í•©ë‹ˆë‹¤"
    await migrateToLocalFirst();
  }

  5-2. ë¡¤ë°± ê³„íš

  - ì´ì „ ë²„ì „ ë°ì´í„° ë°±ì—…
  - ë¬¸ì œ ë°œìƒ ì‹œ ë³µêµ¬ ì˜µì…˜

  ---
  ğŸ¯ êµ¬í˜„ ìš°ì„ ìˆœìœ„ ë§¤íŠ¸ë¦­ìŠ¤

  | Phase     | ë‚œì´ë„   | íš¨ê³¼    | ë¦¬ìŠ¤í¬  | ì¶”ì²œ ìˆœì„œ |
  |-----------|-------|-------|------|-------|
  | 1. ì½ê¸° ìµœì í™” | â­â­    | â­â­â­â­â­ | â­    | 1ë²ˆ    |
  | 2. ì“°ê¸° ìµœì í™” | â­â­â­   | â­â­â­â­  | â­â­   | 2ë²ˆ    |
  | 3. ì¶©ëŒ í•´ê²°  | â­â­â­â­  | â­â­â­   | â­â­â­  | 4ë²ˆ    |
  | 4. ê³ ê¸‰ ê¸°ëŠ¥  | â­â­â­â­â­ | â­â­    | â­â­   | 5ë²ˆ    |
  | 5. ë§ˆì´ê·¸ë ˆì´ì…˜ | â­â­â­   | â­â­â­â­  | â­â­â­â­ | 3ë²ˆ    |

  ---
  ğŸš€ Quick Win ì „ëµ

  ì¦‰ì‹œ êµ¬í˜„ ê°€ëŠ¥í•œ ê²ƒë“¤ (1-2ì¼):
  1. í™ˆ í™”ë©´ ë¡œì»¬ ìºì‹œ
  2. ì¹œêµ¬ ëª©ë¡ ë¡œì»¬ ìºì‹œ
  3. í…Œë§ˆ/ì¹´í˜ ê²€ìƒ‰ ê²°ê³¼ ìºì‹±

  ì½”ë“œ ì˜ˆì‹œ:
  // main.dart ìˆ˜ì •
  Future<void> loadInitialData() async {
    // ê¸°ì¡´: DBì—ì„œë§Œ ë¡œë“œ
    // diaries = await DatabaseService.getMyDiaries();

    // ê°œì„ : ë¡œì»¬ ìš°ì„ 
    diaries = await LocalStorage.getDiaries() ?? [];
    setState(() {}); // ì¦‰ì‹œ UI í‘œì‹œ

    // ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™”
    Future.microtask(() async {
      final serverDiaries = await DatabaseService.getMyDiaries();
      if (serverDiaries != diaries) {
        setState(() => diaries = serverDiaries);
        await LocalStorage.saveDiaries(serverDiaries);
      }
    });
  }

  ì´ë ‡ê²Œ ë‹¨ê³„ë³„ë¡œ ì§„í–‰í•˜ë©´ ë¦¬ìŠ¤í¬ë¥¼ ìµœì†Œí™”í•˜ë©´ì„œë„ ë¹ ë¥´ê²Œ ì„±ëŠ¥ ê°œì„ ì„ ì²´ê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.





ì˜¤í”„ë¼ì¸ ì²˜ë¦¬ ì „ëµ

  1. ê¸°ë³¸ ì›ì¹™: ë¡œì»¬ ìš°ì„ , ë„¤íŠ¸ì›Œí¬ëŠ” ì„ íƒì 

  ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ êµ¬ë¶„ ì—†ì´ ë™ì¼í•œ UX ì œê³µ
  - ë¡œì»¬ì´ ì§„ì§œ ë°ì´í„°
  - DBëŠ” ë°±ì—…/ë™ê¸°í™”ìš©

  2. ìƒíƒœë³„ ë™ì‘ ì‹œë‚˜ë¦¬ì˜¤

  ğŸ“± ì™„ì „ ì˜¤í”„ë¼ì¸ ìƒíƒœ

  // ëª¨ë“  ì‘ì—…ì´ ë¡œì»¬ì—ì„œë§Œ ì²˜ë¦¬
  - ì¼ì§€ ì‘ì„± â†’ Hive ì €ì¥ â†’ ë™ê¸°í™” íì— ì¶”ê°€
  - ì¹œêµ¬ ì¶”ê°€ â†’ Hive ì €ì¥ â†’ ë™ê¸°í™” íì— ì¶”ê°€
  - ìˆ˜ì •/ì‚­ì œ â†’ Hive ìˆ˜ì • â†’ ë™ê¸°í™” íì— ì¶”ê°€

  // ë™ê¸°í™” í êµ¬ì¡°
  SyncQueue {
    id: local_timestamp_123,
    type: 'CREATE_DIARY',
    data: DiaryEntry,
    status: 'pending',
    retryCount: 0,
    createdAt: DateTime
  }

  ğŸ”„ ì˜¨ë¼ì¸ ë³µê·€ ì‹œ

  // ìë™ ë™ê¸°í™” í”„ë¡œì„¸ìŠ¤
  1. ë™ê¸°í™” í í™•ì¸
  2. pending í•­ëª©ë“¤ ìˆœì°¨ ì²˜ë¦¬
  3. ì„±ê³µ â†’ íì—ì„œ ì œê±°
  4. ì‹¤íŒ¨ â†’ retryCount++, ë‚˜ì¤‘ì— ì¬ì‹œë„

  3. ì¶©ëŒ í•´ê²° ì „ëµ

  ì‹œë‚˜ë¦¬ì˜¤ 1: ê°™ì€ ì‚¬ìš©ì, ë‹¤ë¥¸ ê¸°ê¸°

  ê¸°ê¸° A (ì˜¤í”„ë¼ì¸): ì¼ì§€ ì‘ì„±
  ê¸°ê¸° B (ì˜¨ë¼ì¸): ê°™ì€ ë‚  ë‹¤ë¥¸ ì¼ì§€ ì‘ì„±

  í•´ê²°: ë‘˜ ë‹¤ ìœ ì§€ (ë³‘í•©)
  - ê°™ì€ ë‚  ì—¬ëŸ¬ ì¼ì§€ ê°€ëŠ¥í•˜ë¯€ë¡œ ì¶©ëŒ ì•„ë‹˜

  ì‹œë‚˜ë¦¬ì˜¤ 2: ìˆ˜ì • ì¶©ëŒ

  ê¸°ê¸° A: ì¼ì§€ ìˆ˜ì • (ì˜¤í”„ë¼ì¸)
  ê¸°ê¸° B: ê°™ì€ ì¼ì§€ ìˆ˜ì • (ì˜¨ë¼ì¸)

  í•´ê²°: Last-Write-Wins (íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€)
  - ê° ìˆ˜ì •ì— localTimestamp + deviceId í¬í•¨
  - ìµœì‹  ê²ƒìœ¼ë¡œ ë®ì–´ì“°ê¸°

  4. êµ¬ì²´ì ì¸ êµ¬í˜„ ë°©ë²•

  Step 1: ë™ê¸°í™” ìƒíƒœ í‘œì‹œ

  class DiaryEntry {
    // ê¸°ì¡´ í•„ë“œë“¤...

    // ë™ê¸°í™” ë©”íƒ€ë°ì´í„° ì¶”ê°€
    DateTime? lastSyncedAt;
    bool hasLocalChanges = false;
    String? syncError;
  }

  // UIì— ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
  Widget buildSyncIndicator(DiaryEntry entry) {
    if (entry.hasLocalChanges) {
      return Icon(Icons.cloud_upload, color: Colors.orange); // ë™ê¸°í™” ëŒ€ê¸°
    } else if (entry.syncError != null) {
      return Icon(Icons.cloud_off, color: Colors.red); // ë™ê¸°í™” ì‹¤íŒ¨
    } else {
      return Icon(Icons.cloud_done, color: Colors.green); // ë™ê¸°í™” ì™„ë£Œ
    }
  }

  Step 2: ë™ê¸°í™” ë§¤ë‹ˆì €

  class SyncManager {
    // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì£¼ê¸°ì  ì‹¤í–‰
    Future<void> syncAll() async {
      if (!isOnline) return;

      // 1. ë¡œì»¬ ë³€ê²½ì‚¬í•­ ì—…ë¡œë“œ
      final pendingChanges = await LocalStorage.getPendingChanges();
      for (final change in pendingChanges) {
        try {
          await uploadChange(change);
          await LocalStorage.markAsSynced(change.id);
        } catch (e) {
          // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íì— ìœ ì§€
        }
      }

      // 2. ì„œë²„ ë³€ê²½ì‚¬í•­ ë‹¤ìš´ë¡œë“œ (ì„ íƒì )
      final serverChanges = await getServerChangesSince(lastSyncTime);
      await mergeServerChanges(serverChanges);
    }
  }

  5. íŠ¹ìˆ˜ ê¸°ëŠ¥ ì²˜ë¦¬

  ğŸ” í…Œë§ˆ/ì¹´í˜ ê²€ìƒ‰ (ê³µí†µ ë°ì´í„°)

  // ì „ëµ: ì£¼ê¸°ì  ìºì‹±
  - ì•± ì‹œì‘ ì‹œ í…Œë§ˆ/ì¹´í˜ ëª©ë¡ ë‹¤ìš´ë¡œë“œ â†’ ë¡œì»¬ ìºì‹œ
  - ì˜¤í”„ë¼ì¸ì—ì„œëŠ” ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
  - ì˜¨ë¼ì¸ ë³µê·€ ì‹œ ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸

  ğŸ‘¥ ì¹œêµ¬ ì½”ë“œ ì—°ë™

  // ì˜¤í”„ë¼ì¸ì—ì„œëŠ” ë¶ˆê°€ëŠ¥
  - "ë„¤íŠ¸ì›Œí¬ ì—°ê²° í›„ ì‹œë„í•´ì£¼ì„¸ìš”" ì•ˆë‚´
  - ë˜ëŠ” ì½”ë“œ ì €ì¥ í›„ ì˜¨ë¼ì¸ ì‹œ ìë™ ì—°ë™

  6. ì‚¬ìš©ì ê²½í—˜ ìµœì í™”

  // íˆ¬ëª…í•œ ì˜¤í”„ë¼ì¸ ê²½í—˜
  1. ì˜¤í”„ë¼ì¸ ë°°ë„ˆ ìµœì†Œí™” (ì‘ê²Œ, í•„ìš”ì‹œë§Œ)
  2. ëª¨ë“  ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥ (ë„¤íŠ¸ì›Œí¬ í•„ìˆ˜ ê¸°ëŠ¥ ì œì™¸)
  3. ë™ê¸°í™”ëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì¡°ìš©íˆ
  4. ì¶©ëŒ ë°œìƒ ì‹œë§Œ ì‚¬ìš©ìì—ê²Œ ì„ íƒ ìš”ì²­

  7. êµ¬í˜„ ìš°ì„ ìˆœìœ„

  Phase 1 (ì¦‰ì‹œ êµ¬í˜„ ê°€ëŠ¥)
  - ì½ê¸°ë¥¼ ë¡œì»¬ ìš°ì„ ìœ¼ë¡œ ë³€ê²½
  - ì“°ê¸°ëŠ” ë¡œì»¬ + DB ë™ì‹œ ì €ì¥

  Phase 2
  - ì˜¤í”„ë¼ì¸ ì“°ê¸° í êµ¬í˜„
  - ìë™ ë™ê¸°í™”

  Phase 3
  - ì¶©ëŒ í•´ê²°
  - ë‹¤ì¤‘ ê¸°ê¸° ì§€ì›

  ì´ë ‡ê²Œ í•˜ë©´ ì˜¤í”„ë¼ì¸ì—ì„œë„ ê±°ì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê³ , ì˜¨ë¼ì¸ ë³µê·€ ì‹œ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ ê±°ì˜ ì‹ ê²½ ì“¸ í•„ìš”ê°€ ì—†ê²Œ ë©ë‹ˆë‹¤.



ID ì²´ê³„ í†µí•© ì „ëµ

  ğŸ“Œ í˜„ì¬ ìƒí™© ë¶„ì„

  // í˜„ì¬ ì½”ë“œ
  - ë¡œì»¬ ID: ìŒìˆ˜ (ì˜ˆ: -1, -2, -3...)
  - DB ID: ì–‘ìˆ˜ SERIAL (ì˜ˆ: 1, 2, 3...)
  - ë¬¸ì œ: ë™ì¼ ë°ì´í„°ê°€ ë‹¤ë¥¸ IDë¥¼ ê°€ì§

  ğŸ”‘ í•´ê²° ë°©ì•ˆ: UUID ê¸°ë°˜ í†µí•© ID

  Option 1: UUID ì „ë©´ ë„ì… (ì¶”ì²œ)

  class DiaryEntry {
    String id;  // UUID (ì˜ˆ: "550e8400-e29b-41d4-a716-446655440000")
    int? legacyId;  // ê¸°ì¡´ DBì˜ SERIAL ID (ë§ˆì´ê·¸ë ˆì´ì…˜ìš©)

    DiaryEntry.create() {
      id = Uuid().v4();  // ë¡œì»¬ì—ì„œ ì¦‰ì‹œ ìƒì„±
    }
  }

  ì¥ì :
  - ë¡œì»¬ì—ì„œ ìƒì„± ì¦‰ì‹œ ì˜êµ¬ ID ë¶€ì—¬
  - ì¶©ëŒ ê°€ëŠ¥ì„± ì‚¬ì‹¤ìƒ 0%
  - ë‹¤ì¤‘ ê¸°ê¸°ì—ì„œë„ ì•ˆì „

  DB ìŠ¤í‚¤ë§ˆ ë³€ê²½:
  ALTER TABLE diary_entries
  ADD COLUMN uuid VARCHAR(36) UNIQUE;

  -- ê¸°ì¡´ ë°ì´í„°ì— UUID ë¶€ì—¬
  UPDATE diary_entries
  SET uuid = gen_random_uuid()
  WHERE uuid IS NULL;

  -- ì¶”í›„ uuidë¥¼ PRIMARY KEYë¡œ ì „í™˜

  Option 2: Hybrid ID (í˜„ì‹¤ì  ì ‘ê·¼)

  class DiaryEntry {
    String compositeId;  // "local_" ë˜ëŠ” "db_" prefix
    int? dbId;           // DB SERIAL ID
    String? localId;     // ë¡œì»¬ ê³ ìœ  ID

    // ìƒì„±ì
    DiaryEntry.createLocal() {
      localId = '${DateTime.now().millisecondsSinceEpoch}_${deviceId}';
      compositeId = 'local_$localId';
    }

    // DB ì €ì¥ í›„
    void syncWithDb(int serverGeneratedId) {
      dbId = serverGeneratedId;
      compositeId = 'db_$serverGeneratedId';
      localId = null;  // ë” ì´ìƒ ë¶ˆí•„ìš”
    }
  }

  ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

  Phase 1: ê¸°ì¡´ ë°ì´í„° ë³´ì¡´

  // ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘
  class MigrationService {
    static Future<void> addUuidToExisting() async {
      // 1. DBì˜ ê¸°ì¡´ ë°ì´í„°ì— UUID ì¶”ê°€
      final dbEntries = await DatabaseService.getAllEntries();
      for (final entry in dbEntries) {
        entry.uuid = Uuid().v4();
        await DatabaseService.updateUuid(entry);
      }

      // 2. ë¡œì»¬ì˜ ê¸°ì¡´ ë°ì´í„° ë§¤í•‘
      final localEntries = await LocalStorage.getAllEntries();
      for (final entry in localEntries) {
        if (entry.id < 0) {  // ë¡œì»¬ ì „ìš© ë°ì´í„°
          entry.uuid = Uuid().v4();
          entry.needsSync = true;
        }
      }
    }
  }

  Phase 2: ì¹œêµ¬ ë°ì´í„° í†µí•©

  class Friend {
    String id;  // UUID
    int? legacyFriendId;  // ê¸°ì¡´ friends.id
    String? connectedUserId;  // ê·¸ëŒ€ë¡œ ìœ ì§€

    // ì—°ê²° ê´€ê³„ë„ UUIDë¡œ
    Map<String, dynamic> toJson() {
      return {
        'id': id,  // UUID
        'legacy_id': legacyFriendId,
        'connected_user_id': connectedUserId,
        //...
      };
    }
  }

  ğŸ’¾ ë¡œì»¬ ì €ì¥ì†Œ êµ¬ì¡° ê°œì„ 

  // Hive ë°•ìŠ¤ êµ¬ì¡° ë³€ê²½
  class LocalStorageService {
    // ê¸°ì¡´: IDë¥¼ í‚¤ë¡œ ì‚¬ìš©
    // Box<DiaryEntry> diaryBox;  // key: int ID

    // ê°œì„ : UUIDë¥¼ í‚¤ë¡œ ì‚¬ìš©
    static final Box<String> diaryBox = Hive.box('diary_v2');

    static Future<void> saveDiary(DiaryEntry entry) async {
      // UUIDë¥¼ í‚¤ë¡œ ì‚¬ìš©
      await diaryBox.put(entry.id, entry.toJson());
    }

    static DiaryEntry? getDiary(String uuid) {
      final json = diaryBox.get(uuid);
      return json != null ? DiaryEntry.fromJson(json) : null;
    }
  }

  ğŸ”— ì°¸ì¡° ë¬´ê²°ì„± ìœ ì§€

  // ì¼ì§€-ì¹œêµ¬ ê´€ê³„ë„ UUIDë¡œ
  class DiaryEntryParticipant {
    String diaryId;   // diary UUID
    String? friendId; // friend UUID
    String? userId;   // user UUID (Supabase auth)
  }

  // ì¡°íšŒ ì‹œ
  static Future<List<Friend>> getDiaryParticipants(String diaryUuid) async {
    // UUID ê¸°ë°˜ ì¡°íšŒ
    final participants = await supabase
      .from('diary_entry_participants')
      .select()
      .eq('diary_uuid', diaryUuid);
    //...
  }

  ğŸš€ êµ¬í˜„ ìˆœì„œ

  Step 1: ì‹ ê·œ ë°ì´í„°ë¶€í„° UUID ì ìš©

  // ì¦‰ì‹œ ì ìš© ê°€ëŠ¥
  class DiaryEntry {
    late String id;
    int? dbId;  // ì„ì‹œ ë³´ê´€

    DiaryEntry.create() {
      id = const Uuid().v4();  // ì‹ ê·œ ìƒì„± ì‹œ UUID
    }
  }

  Step 2: ê¸°ì¡´ ë°ì´í„° ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜

  // ì•± ì‹œì‘ ì‹œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ
  if (needsMigration) {
    await MigrationService.migrateToUuid();
    // ì‚¬ìš©ì ëª¨ë¥´ê²Œ ì¡°ìš©íˆ ì§„í–‰
  }

  Step 3: ë ˆê±°ì‹œ ID ì œê±°

  // ëª¨ë“  ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„
  // 3-6ê°œì›” í›„ ë ˆê±°ì‹œ ì»¬ëŸ¼ ì œê±°

  âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

  // ì˜í–¥ë°›ëŠ” ë¶€ë¶„ë“¤
  - [ ] diary_entries í…Œì´ë¸”: uuid ì»¬ëŸ¼ ì¶”ê°€
  - [ ] friends í…Œì´ë¸”: uuid ì»¬ëŸ¼ ì¶”ê°€
  - [ ] participants í…Œì´ë¸”: uuid ì°¸ì¡°ë¡œ ë³€ê²½
  - [ ] LocalStorageService: UUID í‚¤ ì‚¬ìš©
  - [ ] ëª¨ë“  ì¡°íšŒ ì¿¼ë¦¬: UUID ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½
  - [ ] ë™ê¸°í™” ë¡œì§: UUIDë¡œ ë§¤ì¹­

  ì´ë ‡ê²Œ UUIDë¡œ í†µì¼í•˜ë©´ ë¡œì»¬-ì˜¨ë¼ì¸ êµ¬ë¶„ ì—†ì´ ë™ì¼í•œ IDë¡œ ë°ì´í„°ë¥¼ ì¶”ì í•  ìˆ˜ ìˆê³ , ë™ê¸°í™”ê°€ í›¨ì”¬ ê°„ë‹¨í•´ì§‘ë‹ˆë‹¤!

> í…Œë§ˆë‚˜ ì¹´í˜ë¥¼ ê²€ìƒ‰í•˜ëŠ”ë¶€ë¶„ì€ ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œ?\
  ê·¸ê±´ ì˜¨ë¼ì¸ì´ ê°€ëŠ¥í•œ ê²½ìš°ì—ë§Œ í•˜ê²Œ í• ê¹Œ?

âº í…Œë§ˆ/ì¹´í˜ ê²€ìƒ‰ì€ í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ì„ ì¶”ì²œí•©ë‹ˆë‹¤! ì˜¤í”„ë¼ì¸ì—ì„œë„ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë˜, ë°ì´í„° íŠ¹ì„±ì— ë§ê²Œ ì „ëµì„ ë‹¤ë¥´ê²Œ ê°€ì ¸ê°€ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

  í…Œë§ˆ/ì¹´í˜ ê²€ìƒ‰ ì „ëµ

  ğŸ“Š ë°ì´í„° íŠ¹ì„± ë¶„ì„

  í…Œë§ˆ ë°ì´í„°: ì•½ 2000-5000ê°œ ì¶”ì •
  ì¹´í˜ ë°ì´í„°: ì•½ 200-500ê°œ ì¶”ì •
  ì´ ìš©ëŸ‰: ì•½ 1-2MB (í…ìŠ¤íŠ¸ë§Œ)
  ë³€ê²½ ë¹ˆë„: ë‚®ìŒ (ì£¼ 1-2íšŒ ìƒˆ í…Œë§ˆ ì¶”ê°€)

  ğŸ¯ ì¶”ì²œ ì „ëµ: ìŠ¤ë§ˆíŠ¸ ìºì‹±

  1. ì´ˆê¸° ë‹¤ìš´ë¡œë“œ + ì •ê¸° ì—…ë°ì´íŠ¸

  class ThemeCacheService {
    static const Duration CACHE_DURATION = Duration(days: 7);

    // ì•± ì²« ì‹¤í–‰ ë˜ëŠ” ìºì‹œ ë§Œë£Œ ì‹œ
    static Future<void> initializeCache() async {
      final lastUpdated = LocalStorage.getLastThemeUpdate();

      if (lastUpdated == null ||
          DateTime.now().difference(lastUpdated) > CACHE_DURATION) {
        await downloadAllThemes();
      }
    }

    // ì „ì²´ í…Œë§ˆ/ì¹´í˜ ë‹¤ìš´ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œ)
    static Future<void> downloadAllThemes() async {
      try {
        // í”„ë¡œê·¸ë ˆìŠ¤ í‘œì‹œ
        showDownloadProgress("í…Œë§ˆ ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘...");

        final themes = await DatabaseService.getAllThemes(limit: 5000);
        final cafes = await DatabaseService.getAllCafes();

        // ë¡œì»¬ì— ì €ì¥
        await LocalStorage.saveThemes(themes);
        await LocalStorage.saveCafes(cafes);
        await LocalStorage.setLastThemeUpdate(DateTime.now());

        // ê²€ìƒ‰ ì¸ë±ìŠ¤ êµ¬ì¶•
        await buildSearchIndex(themes, cafes);
      } catch (e) {
        // ì‹¤íŒ¨í•´ë„ ê¸°ì¡´ ìºì‹œ ì‚¬ìš©
        print('í…Œë§ˆ ìºì‹œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: $e');
      }
    }
  }

  2. ì˜¤í”„ë¼ì¸ ê²€ìƒ‰ ìµœì í™”

  class OfflineSearchService {
    // ê²€ìƒ‰ ì¸ë±ìŠ¤ (ë©”ëª¨ë¦¬ ìºì‹œ)
    static Map<String, List<EscapeTheme>> searchIndex = {};

    // ê²€ìƒ‰ ì¸ë±ìŠ¤ êµ¬ì¶• (ì•± ì‹œì‘ ì‹œ 1íšŒ)
    static Future<void> buildSearchIndex(List<EscapeTheme> themes, List<EscapeCafe> cafes) async {
      // 1. í…Œë§ˆëª… ì¸ë±ì‹±
      for (final theme in themes) {
        final keywords = _extractKeywords(theme.name);
        for (final keyword in keywords) {
          searchIndex[keyword] ??= [];
          searchIndex[keyword]!.add(theme);
        }
      }

      // 2. ì´ˆì„± ê²€ìƒ‰ ì§€ì›
      // "ì‹ ë°ë ë¼" â†’ "ã……ã„·ã„¹ã„¹"
      for (final theme in themes) {
        final chosung = _extractChosung(theme.name);
        searchIndex[chosung] ??= [];
        searchIndex[chosung]!.add(theme);
      }
    }

    // ë¹ ë¥¸ ë¡œì»¬ ê²€ìƒ‰
    static List<EscapeTheme> searchThemes(String query) {
      if (query.length < 1) return [];

      final results = <EscapeTheme>{};
      final queryLower = query.toLowerCase();

      // 1. ì¸ë±ìŠ¤ ê¸°ë°˜ ê²€ìƒ‰ (ë¹ ë¦„)
      if (searchIndex.containsKey(queryLower)) {
        results.addAll(searchIndex[queryLower]!);
      }

      // 2. ë¶€ë¶„ ë¬¸ìì—´ ê²€ìƒ‰ (ëŠë¦¬ì§€ë§Œ ì •í™•)
      final allThemes = LocalStorage.getCachedThemes();
      results.addAll(
        allThemes.where((t) =>
          t.name.toLowerCase().contains(queryLower) ||
          (t.searchKeywords?.toLowerCase().contains(queryLower) ?? false)
        )
      );

      return results.toList();
    }
  }

  ğŸ”„ ë™ê¸°í™” ì „ëµ

  3ë‹¨ê³„ ì ‘ê·¼ë²•

  class ThemeSearchStrategy {

    // Level 1: ì¦‰ì‹œ ë¡œì»¬ ê²€ìƒ‰
    static Future<List<EscapeTheme>> search(String query) async {
      // 1. ë¡œì»¬ ìºì‹œì—ì„œ ì¦‰ì‹œ ê²€ìƒ‰
      final localResults = OfflineSearchService.searchThemes(query);

      // 2. ì˜¨ë¼ì¸ì´ë©´ ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
      if (ConnectivityService.isOnline) {
        _backgroundUpdate(query);
      }

      return localResults;
    }

    // Level 2: ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
    static Future<void> _backgroundUpdate(String query) async {
      try {
        // ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ì¡°íšŒ
        final serverResults = await DatabaseService.searchThemes(query);

        // ìƒˆë¡œìš´ í…Œë§ˆ ë°œê²¬ ì‹œ ìºì‹œ ì—…ë°ì´íŠ¸
        final cachedIds = LocalStorage.getCachedThemeIds();
        final newThemes = serverResults.where((t) => !cachedIds.contains(t.id));

        if (newThemes.isNotEmpty) {
          await LocalStorage.addThemes(newThemes);
          // UI ë¦¬í”„ë ˆì‹œ íŠ¸ë¦¬ê±°
          ThemeUpdateNotifier.notify();
        }
      } catch (e) {
        // ì‹¤íŒ¨ ë¬´ì‹œ (ë¡œì»¬ ê²°ê³¼ ì´ë¯¸ í‘œì‹œë¨)
      }
    }

    // Level 3: ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
    static Future<void> forceRefresh() async {
      if (!ConnectivityService.isOnline) {
        throw Exception('ì¸í„°ë„· ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤');
      }

      await ThemeCacheService.downloadAllThemes();
    }
  }

  ğŸ¨ UI/UX ì²˜ë¦¬

  ê²€ìƒ‰ í™”ë©´ êµ¬í˜„

  class ThemeSearchWidget extends StatefulWidget {
    @override
    Widget build(BuildContext context) {
      return Column(
        children: [
          // ê²€ìƒ‰ ë°”
          TextField(
            onChanged: (query) => _search(query),
            decoration: InputDecoration(
              hintText: 'í…Œë§ˆ ë˜ëŠ” ì¹´í˜ ê²€ìƒ‰',
              suffixIcon: _buildStatusIcon(),
            ),
          ),

          // ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì•ˆë‚´ (í•„ìš”ì‹œë§Œ)
          if (!isOnline && isDataStale)
            Container(
              color: Colors.orange.shade100,
              padding: EdgeInsets.all(8),
              child: Row(
                children: [
                  Icon(Icons.info_outline, size: 16),
                  SizedBox(width: 8),
                  Expanded(
                    child: Text(
                      'ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ${lastUpdateDays}ì¼ ì „ ë°ì´í„°',
                      style: TextStyle(fontSize: 12),
                    ),
                  ),
                  TextButton(
                    onPressed: _requestOnlineUpdate,
                    child: Text('ì—…ë°ì´íŠ¸'),
                  ),
                ],
              ),
            ),

          // ê²€ìƒ‰ ê²°ê³¼
          Expanded(
            child: ListView.builder(
              itemCount: searchResults.length,
              itemBuilder: (context, index) {
                final theme = searchResults[index];
                return ListTile(
                  title: Text(theme.name),
                  subtitle: Text(theme.cafe.name),
                  trailing: _buildDataSourceIcon(theme),
                );
              },
            ),
          ),
        ],
      );
    }

    Widget _buildStatusIcon() {
      if (isSearching) return CircularProgressIndicator(strokeWidth: 2);
      if (!isOnline) return Icon(Icons.offline_bolt, color: Colors.grey);
      if (isDataStale) return Icon(Icons.sync, color: Colors.orange);
      return Icon(Icons.check_circle, color: Colors.green);
    }

    Widget _buildDataSourceIcon(EscapeTheme theme) {
      if (theme.isNewFromServer) {
        return Chip(
          label: Text('NEW', style: TextStyle(fontSize: 10)),
          backgroundColor: Colors.green.shade100,
        );
      }
      return SizedBox.shrink();
    }
  }

  ğŸ“± ì²« ì‹¤í–‰ ì‹œë‚˜ë¦¬ì˜¤

  class FirstLaunchExperience {
    static Future<void> initialize() async {
      // 1. ê¸°ë³¸ ë°ì´í„° í¬í•¨ (ì•± ë²ˆë“¤)
      if (isFirstLaunch) {
        // assets/initial_themes.json í¬í•¨
        final bundledData = await loadBundledThemes();
        await LocalStorage.saveThemes(bundledData);

        // ì‚¬ìš©ìëŠ” ì¦‰ì‹œ ê²€ìƒ‰ ê°€ëŠ¥!
      }

      // 2. ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
      if (isOnline) {
        Future.delayed(Duration(seconds: 2), () {
          ThemeCacheService.downloadAllThemes();
        });
      }
    }
  }

  ğŸ”§ ì„¤ì • ì˜µì…˜

  class SearchSettings {
    // ì‚¬ìš©ì ì„¤ì •
    bool downloadOnWifiOnly = true;
    bool autoUpdateThemes = true;
    int cacheExpiryDays = 7;

    // ì„¤ì • UI
    Widget build() {
      return Column(
        children: [
          SwitchListTile(
            title: Text('Wi-Fiì—ì„œë§Œ í…Œë§ˆ ì—…ë°ì´íŠ¸'),
            value: downloadOnWifiOnly,
          ),
          ListTile(
            title: Text('í…Œë§ˆ ë°ì´í„° ê´€ë¦¬'),
            subtitle: Text('${cachedThemeCount}ê°œ í…Œë§ˆ ì €ì¥ë¨ (${cacheSize}MB)'),
            trailing: TextButton(
              child: Text('ìºì‹œ ì‚­ì œ'),
              onPressed: clearCache,
            ),
          ),
        ],
      );
    }
  }

  âœ… ê²°ë¡ : ì¶”ì²œ êµ¬í˜„ ë°©ì‹

  1. ê¸°ë³¸ ì „ëµ: ë¡œì»¬ ìºì‹œ ìš°ì„ , ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸
  2. ì´ˆê¸° ë°ì´í„°: ì•±ì— ê¸°ë³¸ ë°ì´í„° í¬í•¨ (ìì£¼ ì‚¬ìš©ë˜ëŠ” í…Œë§ˆ 500ê°œ)
  3. ì—…ë°ì´íŠ¸ ì£¼ê¸°: ì£¼ 1íšŒ ìë™, ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ê°€ëŠ¥
  4. ì˜¤í”„ë¼ì¸: ì™„ë²½ ì§€ì› (ìºì‹œëœ ë°ì´í„°ë¡œ ê²€ìƒ‰)
  5. ìš©ëŸ‰ ê´€ë¦¬: 1-2MBë¡œ ë¶€ë‹´ ì—†ìŒ

  ì´ë ‡ê²Œ í•˜ë©´ ì˜¤í”„ë¼ì¸ì—ì„œë„ ê²€ìƒ‰ì´ ê°€ëŠ¥í•˜ê³ , ì˜¨ë¼ì¸ì¼ ë•ŒëŠ” í•­ìƒ ìµœì‹  ë°ì´í„°ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!